datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/client"
}

// ============================================
// USER & AUTHENTICATION (Better Auth)
// ============================================

model User {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Better Auth required fields
  name          String?
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?

  // Legacy fields (backward compatibility)
  displayName   String?
  avatarUrl     String?

  // Relations
  leagueMemberships LeagueMember[]
  sessions          Session[]
  accounts          Account[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

enum Platform {
  SLEEPER
  YAHOO
  ESPN
}

// ============================================
// LEAGUES
// ============================================

model League {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform         Platform
  platformLeagueId String
  name             String
  season           Int
  leagueType       LeagueType    @default(REDRAFT)
  scoringFormat    ScoringFormat @default(PPR)
  rosterSize       Int           @default(15)
  teamCount        Int

  members      LeagueMember[]
  rosters      Roster[]
  matchups     Matchup[]
  transactions Transaction[]

  // Phase 4: Analytics relations
  settings        LeagueSettings?
  weeklyAnalytics TeamWeeklyAnalytics[]
  seasonAnalytics TeamSeasonAnalytics[]
  superlatives    LeagueSuperlative[]

  @@unique([platform, platformLeagueId, season])
  @@map("leagues")
}

enum LeagueType {
  REDRAFT
  KEEPER
  DYNASTY
}

enum ScoringFormat {
  STANDARD
  HALF_PPR
  PPR
  CUSTOM
}

model LeagueMember {
  id       String @id @default(cuid())

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  teamName      String?
  teamAvatar    String?
  rosterSlot    Int
  wins          Int     @default(0)
  losses        Int     @default(0)
  ties          Int     @default(0)
  pointsFor     Decimal @default(0) @db.Decimal(10, 2)
  pointsAgainst Decimal @default(0) @db.Decimal(10, 2)

  rosters Roster[]

  // Phase 4: Analytics relations
  weeklyAnalytics TeamWeeklyAnalytics[]
  seasonAnalytics TeamSeasonAnalytics?
  superlatives    LeagueSuperlative[]

  @@unique([leagueId, rosterSlot])
  @@unique([leagueId, userId])
  @@map("league_members")
}

// ============================================
// PLAYERS
// ============================================

model Player {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nflverseId   String? @unique
  sleeperId    String? @unique
  yahooId      String? @unique
  espnId       String? @unique

  firstName    String
  lastName     String
  fullName     String
  position     Position
  team         String?
  jerseyNumber Int?
  status       PlayerStatus @default(ACTIVE)
  injuryStatus String?
  byeWeek      Int?

  rosterPlayers RosterPlayer[]

  // Phase 4: Analytics relations
  valuations  PlayerValuation[]
  weeklyStats PlayerWeeklyStats[]
  seasonStats PlayerSeasonStats[]

  @@index([position, team])
  @@map("players")
}

enum Position {
  QB
  RB
  WR
  TE
  K
  DEF
  DL
  LB
  DB
  IDP
}

enum PlayerStatus {
  ACTIVE
  INACTIVE
  INJURED_RESERVE
  PRACTICE_SQUAD
  FREE_AGENT
  RETIRED
}

// ============================================
// ROSTERS
// ============================================

model Roster {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  memberId String
  member   LeagueMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  week    Int
  season  Int
  players RosterPlayer[]

  @@unique([memberId, week, season])
  @@map("rosters")
}

model RosterPlayer {
  id       String @id @default(cuid())

  rosterId String
  roster   Roster @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  slot RosterSlot

  @@unique([rosterId, playerId])
  @@map("roster_players")
}

enum RosterSlot {
  QB
  RB
  WR
  TE
  FLEX
  SUPER_FLEX
  K
  DEF
  DL
  LB
  DB
  IDP
  BN
  IR
  TAXI
}

// ============================================
// MATCHUPS
// ============================================

model Matchup {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  week          Int
  season        Int
  homeTeamSlot  Int
  awayTeamSlot  Int
  homeScore     Decimal? @db.Decimal(10, 2)
  awayScore     Decimal? @db.Decimal(10, 2)
  homeProjected Decimal? @db.Decimal(10, 2)
  awayProjected Decimal? @db.Decimal(10, 2)
  isPlayoffs    Boolean  @default(false)
  matchupType   MatchupType @default(REGULAR)

  @@unique([leagueId, week, season, homeTeamSlot, awayTeamSlot])
  @@map("matchups")
}

enum MatchupType {
  REGULAR
  PLAYOFF
  CONSOLATION
  CHAMPIONSHIP
  TOILET_BOWL
}

// ============================================
// PHASE 4: VALUATION ENUMS
// ============================================

enum ValuationSource {
  KTC_DYNASTY
  KTC_REDRAFT
  DYNASTY_PROCESS
}

enum ValueTrend {
  RISING
  STABLE
  FALLING
}

enum BaselineType {
  STRICT
  WAIVER
}

enum SuperlativeType {
  BEST_MANAGER
  WORST_MANAGER
  LUCKIEST_TEAM
  UNLUCKIEST_TEAM
  MOST_CONSISTENT
  BOOM_BUST
  HIGHEST_SCORER
  WEEKLY_MVP
  WEEKLY_LVP
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  type        TransactionType
  status      TransactionStatus @default(COMPLETE)
  processedAt DateTime?
  faabBid     Int?
  metadata    Json?

  adds  TransactionAdd[]
  drops TransactionDrop[]

  @@index([leagueId, createdAt])
  @@map("transactions")
}

enum TransactionType {
  TRADE
  WAIVER
  FREE_AGENT
  COMMISSIONER
}

enum TransactionStatus {
  PENDING
  COMPLETE
  FAILED
  VETOED
}

model TransactionAdd {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  teamSlot Int
  playerId String?
  pickInfo Json?

  @@map("transaction_adds")
}

model TransactionDrop {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  teamSlot Int
  playerId String?
  pickInfo Json?

  @@map("transaction_drops")
}

// ============================================
// PHASE 4: PLAYER VALUATIONS
// ============================================

model PlayerValuation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  source      ValuationSource
  scrapedAt   DateTime
  baseValue   Int
  tier        Int?
  trend       ValueTrend @default(STABLE)
  weeklyDelta Int        @default(0)

  @@unique([playerId, source])
  @@index([source, scrapedAt])
  @@map("player_valuations")
}

model ValuationHistory {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  playerId   String
  source     ValuationSource
  value      Int
  recordedAt DateTime

  @@index([playerId, source, recordedAt])
  @@map("valuation_history")
}

model LeagueSettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagueId String @unique
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  isSuperFlex   Boolean @default(false)
  tePremium     Decimal @default(0) @db.Decimal(3, 2)
  pprValue      Decimal @default(1) @db.Decimal(3, 2)
  rosterSize    Int     @default(15)
  benchSpots    Int     @default(6)
  startingSlots Json    @default("{\"QB\": 1, \"RB\": 2, \"WR\": 2, \"TE\": 1, \"FLEX\": 1}")

  @@map("league_settings")
}

// ============================================
// PHASE 4: PLAYER STATISTICS
// ============================================

model PlayerWeeklyStats {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playerId  String
  player    Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  season    Int
  week      Int
  points    Decimal  @db.Decimal(10, 2)
  projected Decimal? @db.Decimal(10, 2)

  @@unique([playerId, season, week])
  @@map("player_weekly_stats")
}

model PlayerSeasonStats {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playerId     String
  player       Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  season       Int
  totalPoints  Decimal  @db.Decimal(10, 2)
  gamesPlayed  Int      @default(0)
  avgPoints    Decimal  @db.Decimal(10, 2)
  stdDeviation Decimal  @db.Decimal(10, 4)
  vorpStrict   Decimal? @db.Decimal(10, 2)
  vorpWaiver   Decimal? @db.Decimal(10, 2)
  war          Decimal? @db.Decimal(10, 4)

  @@unique([playerId, season])
  @@map("player_season_stats")
}

model PositionBaseline {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  season        Int
  position      Position
  baselineType  BaselineType
  teamCount     Int
  baselineRank  Int
  baselineValue Decimal @db.Decimal(10, 2)

  @@unique([season, position, baselineType, teamCount])
  @@map("position_baselines")
}

// ============================================
// PHASE 4: TEAM ANALYTICS
// ============================================

model TeamWeeklyAnalytics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  memberId String
  member   LeagueMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  season           Int
  week             Int
  actualScore      Decimal @db.Decimal(10, 2)
  optimalScore     Decimal @db.Decimal(10, 2)
  lineupEfficiency Decimal @db.Decimal(5, 2)
  allPlayWins      Int     @default(0)
  allPlayLosses    Int     @default(0)
  allPlayTies      Int     @default(0)
  weeklyRank       Int

  @@unique([memberId, season, week])
  @@map("team_weekly_analytics")
}

model TeamSeasonAnalytics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  memberId String @unique
  member   LeagueMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  season              Int
  totalActualScore    Decimal @db.Decimal(10, 2)
  totalOptimalScore   Decimal @db.Decimal(10, 2)
  avgLineupEfficiency Decimal @db.Decimal(5, 2)
  allPlayWins         Int     @default(0)
  allPlayLosses       Int     @default(0)
  allPlayTies         Int     @default(0)
  allPlayWinPct       Decimal @db.Decimal(5, 4)
  expectedWins        Decimal @db.Decimal(5, 2)
  actualWins          Int
  luckIndex           Decimal @db.Decimal(6, 4)
  pointsStdDev        Decimal @db.Decimal(10, 2)

  @@unique([memberId, season])
  @@map("team_season_analytics")
}

model LeagueSuperlative {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  leagueId        String
  league          League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  season          Int
  week            Int?
  superlativeType SuperlativeType
  memberId        String
  member          LeagueMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  value           Decimal @db.Decimal(10, 2)
  metadata        Json?

  @@unique([leagueId, season, week, superlativeType])
  @@map("league_superlatives")
}

// ============================================
// DISCORD BOT CONFIGURATION
// ============================================

model GuildConfig {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guildId               String  @unique
  guildName             String?
  notificationChannelId String

  // Multi-platform league support
  platform         Platform @default(SLEEPER)
  platformLeagueId String

  // Notification preferences
  tradeAlerts     Boolean @default(true)
  waiverAlerts    Boolean @default(true)
  injuryAlerts    Boolean @default(true)
  lineupReminders Boolean @default(true)

  // Timezone for scheduled notifications
  timezone String @default("America/New_York")

  @@index([platformLeagueId])
  @@map("guild_configs")
}

model UserNotificationPreference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discordUserId String @unique

  // DM notification preferences
  dmTradeAlerts     Boolean @default(false)
  dmLineupReminders Boolean @default(true)
  dmInjuryAlerts    Boolean @default(false)

  // Multi-platform linked accounts
  sleeperUserId String?
  yahooUserId   String?
  espnUserId    String?

  @@map("user_notification_preferences")
}
